{% extends 'crawler/base.html' %}
{% block titleblock %}
<!-- <script src="./src/profile.js"></script> -->
{% load static %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}

{% block infoblock %}
    <h1>Hello {{user}}</h1>
    <table class="columns">
        <tr>
          <td><div id="Submissions Accuracy" style="border: 1px solid #ccc"></div></td>
          <!-- <td><div id="Languages used" style="border: 1px solid #ccc"></div></td> -->
        </tr>
        <tr>
          <td><div id="Official/Unofficial tags" style="border: 1px solid #ccc"></div></td>
          <td><div id="Practice/Virtual tags" style="border: 1px solid #ccc"></div></td>
        </tr>
        <tr>
          <td><div id="Official/Unofficial ratings" style="border: 1px solid #ccc"></div></td>
          <td><div id="Practice/Virtual ratings" style="border: 1px solid #ccc"></div></td>
        </tr>
      </table>
      <script type="text/javascript">
      	let api_url = 'https://codeforces.com/api/'
		let handle = `{{user}}`

		let totalSub = 0
		let submissions = {'AC': 0, 'WA': 0, 'RTE': 0, 'TLE': 0, 
			'MLE': 0, 'CE': 0
		}
        let problems_by_tag = {} //To store problems tag, categorized into contest, unofficial, virtual, practice.
        let problem_ratings = {} //To store problems rating, categorized into contest, unofficial, virtual,  practice.

		google.charts.load('current', {'packages':['corechart']})

		google.charts.setOnLoadCallback(SubmissionsDetails)

		function SubmissionsDetails(){
    		$.get(api_url+'user.status', {handle: handle}, function(data, status)
    			{
    		    if(status){
    		    	totalSub = data.result.length
    		    	// console.log(totalSub)
                    console.log(totalSub)
    		    	for(let i = 0; i < totalSub; i+=1){
    		    		let subinfo = data.result[i]
                        // console.log(subinfo.verdict)
    		    		switch(subinfo.verdict){
    		    			case 'OK':
    		    				submissions['AC']++
                                break
    		    			case 'TIME_LIMIT_EXCEEDED':
    		    				submissions['TLE']++
                                break;
    		    			case 'WRONG_ANSWER':
    		    				submissions['WA']++
                                break;
    		    			case 'MEMORY_LIMIT_EXCEEDED':
    		    				submissions['MLE']++
                                break;
    		    			case 'RUNTIME_ERROR':
    		    				submissions['RTE']++
                                break;
    		    			default:
    		    				submissions['CE']++
    		    		}
                        
                        let tags = subinfo.problem.tags
                        switch(subinfo.author.participantType){
                                case "PRACTICE":
                                    if(problems_by_tag['Practice'] === undefined){
                                        problems_by_tag['Practice'] = {}
                                    }
                                    for(let j=0; j<tags.length; j+=1){
                                        if(problems_by_tag['Practice'][tags[j]] === undefined){
                                            problems_by_tag['Practice'][tags[j]]=1
                                        }
                                        else{
                                            problems_by_tag['Practice'][tags[j]] += 1
                                        }
                                    }
                                    break;
                                case "CONTESTANT":
                                    if(problems_by_tag['Contest'] === undefined){
                                        problems_by_tag['Contest'] = {}
                                    }
                                    for(let j=0; j<tags.length; j+=1){
                                        if(problems_by_tag['Contest'][tags[j]] === undefined){
                                            problems_by_tag['Contest'][tags[j]]=1
                                        }
                                        else{
                                            problems_by_tag['Contest'][tags[j]] += 1
                                        }
                                    }
                                    break;
                                case "OUT_OF_COMPETITION":
                                    if(problems_by_tag['Unofficial'] === undefined){
                                        problems_by_tag['Unofficial'] = {}
                                    }
                                    for(let j=0; j<tags.length; j+=1){
                                        if(problems_by_tag['Unofficial'][tags[j]] === undefined){
                                            problems_by_tag['Unofficial'][tags[j]]=1
                                        }
                                        else{
                                            problems_by_tag['Unofficial'][tags[j]] += 1
                                        }
                                    }                                  
                                    break; 
                                default:
                                    if(problems_by_tag['Virtual'] === undefined){
                                        problems_by_tag['Virtual'] = {}
                                    }
                                    for(let j=0; j<tags.length; j+=1){
                                        if(problems_by_tag['Virtual'][tags[j]] === undefined){
                                            problems_by_tag['Virtual'][tags[j]]=1
                                        }
                                        else{
                                            problems_by_tag['Virtual'][tags[j]] += 1
                                        }
                                    }
                            }

                        if(subinfo.problem.rating){
                            switch(subinfo.author.participantType){
                                case "PRACTICE":
                                    if(problem_ratings['Practice'] === undefined){
                                        problem_ratings['Practice'] = {}
                                    }
                                    if(problem_ratings['Practice'][subinfo.problem.rating] === undefined){
                                        problem_ratings['Practice'][subinfo.problem.rating]=1
                                    }
                                    else{
                                        problem_ratings['Practice'][subinfo.problem.rating]++
                                    }
                                    break;
                                case "CONTESTANT":
                                    if(problem_ratings['Contest'] === undefined){
                                        problem_ratings['Contest'] = {}
                                    }
                                    if(problem_ratings['Contest'][subinfo.problem.rating] === undefined){
                                        problem_ratings['Contest'][subinfo.problem.rating] = 1
                                    }
                                    else{
                                        problem_ratings['Contest'][subinfo.problem.rating]++
                                    }
                                    break;
                                case "OUT_OF_COMPETITION":
                                    if(problem_ratings['Unofficial'] === undefined){
                                        problem_ratings['Unofficial'] = {}
                                    }
                                    if(problem_ratings['Unofficial'][subinfo.problem.rating] === undefined){
                                        problem_ratings['Unofficial'][subinfo.problem.rating] = 1
                                    }
                                    else{
                                        problem_ratings['Unofficial'][subinfo.problem.rating]++
                                    }
                                    break;
                                default:
                                    if(problem_ratings['Virtual'] === undefined){
                                        problem_ratings['Virtual'] = {}
                                    }
                                    if(problem_ratings['Virtual'][subinfo.problem.rating] === undefined){
                                        problem_ratings['Virtual'][subinfo.problem.rating]=1
                                    }
                                    else{
                                        problem_ratings['Virtual'][subinfo.problem.rating]++
                                    }
                            }
                        }
    		    	}
                    if(typeof google.visualization === 'undefined'){
                        google.charts.setOnLoadCallback(drawCharts)
                    }
                    else{
                        drawCharts()
                    }
    		    }
    		    else{

    		    }
    		})
		}
		
		function drawCharts(){
		    let data = new google.visualization.DataTable();

            //Declare Columns
            data.addColumn('string', 'Verdicts');
            data.addColumn('number', 'Submissions');
            let entries = Object.entries(submissions);
            // console.log(entries);
            data.addRows(entries);

            let chart_options = {title:`Verdicts of ${handle}`,
                is3D: true,
                width:800,
                height:400
            };
            let chart = new google.visualization.PieChart(document.  getElementById('Submissions Accuracy'));
            chart.draw(data, chart_options);
// --------------------------------------------------------------------------------------------------------------------
            data  = new google.visualization.DataTable();

            //Declare Columns
            data.addColumn('string', 'Tags');
            data.addColumn('number', 'Counts');

            entries = Object.entries(problems_by_tag['Contest']);
            data.addRows(entries);
            entries = Object.entries(problems_by_tag['Unofficial']);
            data.addRows(entries);

            chart_options = {
                title: `${handle} in Official/Unofficial Contests`,
                pieHole: 0.4,
                width:800,
                height:400
            };
            chart = new google.visualization.PieChart(document.getElementById('Official/Unofficial tags'));
            chart.draw(data, chart_options)

            data = new google.visualization.DataTable();

            //Declare Columns
            data.addColumn('string', 'Tags');
            data.addColumn('number', 'Counts');

            entries = Object.entries(problems_by_tag['Practice']);
            data.addRows(entries);
            entries = Object.entries(problems_by_tag['Virtual']);
            data.addRows(entries);

            chart_options = {
                title: `${handle} in Practice/Virtual Contests`,
                pieHole: 0.4,
                width:800,
                height:400
            };
            chart = new google.visualization.PieChart(document.getElementById('Practice/Virtual tags'));
            chart.draw(data, chart_options)
// --------------------------------------------------------------------------------------------------------------
            data  = new google.visualization.DataTable();

            //Declare Columns
            data.addColumn('string', 'Problem Ratings');
            data.addColumn('number', 'Counts');

            entries = Object.entries(problem_ratings['Contest']);
            data.addRows(entries);
            entries = Object.entries(problem_ratings['Unofficial']);
            data.addRows(entries);

            chart_options = {
                title: `${handle} in Official/Unofficial Contests`,
                pieHole: 0.4,
                width:800,
                height:400
            };
            chart = new google.visualization.PieChart(document.getElementById('Official/Unofficial ratings'));
            chart.draw(data, chart_options)

            data = new google.visualization.DataTable();

            //Declare Columns
            data.addColumn('string', 'Problem Ratings');
            data.addColumn('number', 'Counts');

            entries = Object.entries(problem_ratings['Practice']);
            data.addRows(entries);
            entries = Object.entries(problem_ratings['Virtual']);
            data.addRows(entries);

            chart_options = {
                title: `${handle} in Practice/Virtual Contests`,
                pieHole: 0.4,
                width:800,
                height:400
            };
            chart = new google.visualization.PieChart(document.getElementById('Practice/Virtual ratings'));
            chart.draw(data, chart_options)
		}
        
    </script>
{% endblock %}

